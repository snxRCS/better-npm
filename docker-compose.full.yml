## Better NPM â€“ Full Stack (MariaDB + LLDAP + Docker Secrets)
## Start:
##   1. Create secrets:
##      mkdir -p .secrets
##      echo "your_root_password" > .secrets/db_root_password.txt
##      echo "your_npm_password"  > .secrets/mysql_password.txt
##      chmod 600 .secrets/*.txt
##   2. docker compose -f docker-compose.full.yml up -d
##
## NPM Admin UI:   http://localhost:81    (admin@example.com / changeme)
## LLDAP Admin UI: http://localhost:17170 (admin / admin_password)
##
## After starting, configure LDAP in NPM > Settings > LDAP Authentication:
##   Auth Mode:       Internal + LDAP (or LDAP Only)
##   Host:            lldap
##   Port:            3890
##   Bind DN:         uid=admin,ou=people,dc=example,dc=com
##   Bind Password:   admin_password
##   Base DN:         ou=people,dc=example,dc=com
##   Search Filter:   (|(uid={{USERNAME}})(mail={{USERNAME}}))
##   Email Attribute: mail
##   Name Attribute:  displayName
##   Group Attribute: memberOf

secrets:
  db_root_password:
    file: .secrets/db_root_password.txt
  mysql_password:
    file: .secrets/mysql_password.txt

services:
  app:
    image: "ghcr.io/snxrcs/better-npm:latest"
    restart: unless-stopped
    ports:
      - "80:80"     # Public HTTP Port
      - "443:443"   # Public HTTPS Port
      - "81:81"     # Admin Web Port
    environment:
      TZ: "Europe/Berlin"
      DB_MYSQL_HOST: "db"
      DB_MYSQL_PORT: 3306
      DB_MYSQL_USER: "npm"
      DB_MYSQL_PASSWORD__FILE: /run/secrets/mysql_password
      DB_MYSQL_NAME: "npm"
      # Uncomment this if IPv6 is not enabled on your host
      # DISABLE_IPV6: "true"
    volumes:
      - ./data:/data
      - ./letsencrypt:/etc/letsencrypt
    secrets:
      - mysql_password
    depends_on:
      - db
      - lldap

  db:
    image: "linuxserver/mariadb:latest"
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD__FILE: /run/secrets/db_root_password
      MYSQL_DATABASE: "npm"
      MYSQL_USER: "npm"
      MYSQL_PASSWORD__FILE: /run/secrets/mysql_password
      TZ: "Europe/Berlin"
    volumes:
      - ./mariadb:/config
    secrets:
      - db_root_password
      - mysql_password

  lldap:
    image: "lldap/lldap:latest"
    restart: unless-stopped
    ports:
      - "3890:3890"     # LDAP port
      - "17170:17170"   # Web UI port
    environment:
      LLDAP_JWT_SECRET: "super-secret-change-me-in-production"
      LLDAP_LDAP_USER_PASS: "admin_password"
      LLDAP_LDAP_BASE_DN: "dc=example,dc=com"
    volumes:
      - ./lldap_data:/data
